<?php
session_start();

//Housekeeping
$days = "10"; // delete all files older than this many days
$seconds = ($days*24*60*60);

$dir    = './bibles/';
$files = scandir($dir);

if(count($files) > 500)
{
foreach ($files as $num => $fname){
	if (!is_dir("{$dir}{$fname}") && file_exists("{$dir}{$fname}") && ((time() - filemtime("{$dir}{$fname}")) > $seconds)) {
		$mod_time = filemtime("{$dir}{$fname}");
		unlink("{$dir}{$fname}");
	}
}
}



if(!isset($_SESSION[ip]))
{
	$_SESSION[ip] = $_SERVER['REMOTE_ADDR']; 
	$_SESSION[id] = md5($_SESSION[ip].date("dmyhis"));
	session_cache_expire(3600);
}

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
      
<head>

<script src="http://www.google-analytics.com/urchin.js" 
type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-61151-3";
urchinTracker();
</script>

<link rel = "stylesheet" type="text/css" href="style.css" />

<title>Make Me God</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />

<script src='./javascript/prototype.js' type="text/javascript"></script>

<?PHP
if($_POST[create] == "y" && strlen($_POST[god]) > 0)
{
	//Notify me by mail
	$mail="audun@skeib.com";
	$title="[makemegod]: Bible generated";
	$message="Bible ordered       //Notify me by mail
        $mail="audun@skeib.com";
        $title="[makemegod]: Bible generated";
        $message="Bible ordered with the name ".$_POST[god];
        mail($mail, $title, $message);
 with the name ".$_POST[god];
	mail($mail, $title, $message);


	$god = addslashes(strip_tags($_POST[god]));
	$god = base64_encode($god);
?>

<script type="text/javascript">
function createbible()
{
var myAjax = new Ajax.PeriodicalUpdater('readyfile', 'http://makemegod.com/ajax/bibelforlaget.php?god=<?PHP echo $god; ?>',
  {
    method: 'get',
    frequency: 2
 });
  return true;
} 
</script>

<?PHP
}
	
?>
	
</head>
<body onload="document.godform.god.focus();">

<div id='logo'><a href="index.php"><img src="logo.png" alt="logo"/></a></div>

<?PHP

if($_POST[create] != "y")
{

	$_SESSION[progress] = "";
	
?>

<form method='post' name='godform'  action='index.php'>
<div id='inputbox'>
<input type='text'id='god' maxlength="30" name='god'/><br/>
<input type='hidden' name='create' value='y'/><input type="submit" value='Make me god!'/>
</div>
</form>

<div id='readyfile'>Enter any name to create a bible with your chosen name substituted for "God".<br/>Currently, the script accepts European lettering, space and 0-9.</div>



<?PHP

}
else {



?>

<script type="text/javascript">
var junk = createbible();
</script>

<div id='readyfile' name='readyfile'>Starting process.</div>

<?PHP

}

?>

<div style="text-align: center; margin-top: 50px">&copy; <?PHP echo date("Y"); ?> <a 
href="www.skeib.com">Audun 
Kvasb&oslash;</a> <a href="http://validator.w3.org/check?uri=referer">valid xhtml</a></div>

</body>
</html>
